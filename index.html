<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoPrint File Explorer</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; padding: 20px; max-width: 900px; margin: 0 auto; color: #333; }
        h3 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        
        .breadcrumb { background: white; padding: 15px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; font-weight: 500;}
        .breadcrumb a { text-decoration: none; color: #007bff; }
        
        .item-card {
            background: white; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;
            display: flex; flex-direction: column; 
        }
        
        .row-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }

        /* Tags */
        .tag { font-size: 0.75em; padding: 3px 8px; border-radius: 4px; margin-left: 10px; font-weight: bold; text-transform: uppercase; }
        .tag-dir { background: #e1ecf4; color: #007bff; }
        .tag-stl { background: #d4edda; color: #155724; }
        .tag-other { background: #f0f0f0; color: #666; }

        /* Buttons */
        .btn { padding: 6px 16px; text-decoration: none; color: white; border-radius: 4px; border: none; cursor: pointer; font-size: 0.9em; font-weight: 600; }
        .btn-folder { background: #6c757d; }
        .btn-folder:hover { background: #5a6268; }
        .btn-preview { background: #007bff; margin-right: 5px; }
        .btn-preview:hover { background: #0056b3; }
        .btn-download { background: #28a745; }
        .btn-download:hover { background: #218838; }

        .viewer-box { width: 100%; height: 400px; background: #222; margin-top: 15px; display: none; border-radius: 5px; overflow: hidden;}
    </style>
</head>
<body>

    <h3>CoPrint File Explorer</h3>
    
    <div class="breadcrumb" id="breadcrumb">
        <a href="?path=">üè† Home</a>
    </div>

    <div id="file-list" style="text-align: center;">Loading...</div>

    <script type="module">
        import * as THREE from 'three';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- SETTINGS ---
        const owner = 'coprint';
        const repo = 'AssemblingParts';
        const branch = 'main'; // Change to 'master' if needed
        // ----------------

        const params = new URLSearchParams(window.location.search);
        const currentPath = params.get('path') || '';

        // Breadcrumb
        const bc = document.getElementById('breadcrumb');
        if(currentPath) {
            // Simple split for better breadcrumb visuals could be added here, 
            // but keeping it simple as requested.
            bc.innerHTML += ` <span>/ ${currentPath}</span>`;
        }

        // LIST FILES
        async function listFiles() {
            const listArea = document.getElementById('file-list');
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${currentPath}`;
            
            try {
                const req = await fetch(url);
                if(!req.ok) throw new Error('Repository or folder not found!');
                const data = await req.json();

                listArea.innerHTML = ''; // Clear loading text
                
                // Sort: Folders first
                data.sort((a,b) => (a.type===b.type ? 0 : a.type==='dir' ? -1 : 1));

                if(data.length === 0) {
                    listArea.innerHTML = '<p>Folder is empty.</p>'; 
                    return;
                }

                data.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'item-card';

                    // 1. FOLDER
                    if (item.type === 'dir') {
                        const nextPath = currentPath ? `${currentPath}/${item.name}` : item.name;
                        div.innerHTML = `
                            <div class="row-content">
                                <div>
                                    <b>üìÇ ${item.name}</b> 
                                    <span class="tag tag-dir">FOLDER</span>
                                </div>
                                <a href="?path=${nextPath}" class="btn btn-folder">Open &rarr;</a>
                            </div>`;
                    } 
                    // 2. FILES
                    else {
                        const isSTL = item.name.toUpperCase().endsWith('.STL');
                        const viewerId = `view-${idx}`;
                        
                        let label = isSTL ? '<span class="tag tag-stl">STL MODEL</span>' : '<span class="tag tag-other">FILE</span>';
                        
                        let buttons = `<a href="${item.download_url}" class="btn btn-download" target="_blank">Download</a>`;
                        
                        if (isSTL) {
                             buttons = `
                                <button class="btn btn-preview" onclick="openViewer('${item.path}', '${viewerId}')">üëÅÔ∏è 3D Preview</button>
                                ${buttons}
                             `;
                        }

                        div.innerHTML = `
                            <div class="row-content">
                                <div>
                                    üìÑ ${item.name} ${label}
                                </div>
                                <div>${buttons}</div>
                            </div>
                            <div id="${viewerId}" class="viewer-box"></div>
                        `;
                    }
                    listArea.appendChild(div);
                });

            } catch (err) {
                listArea.innerHTML = `<p style="color:red">Error: ${err.message}<br>Check API limits or repo name.</p>`;
            }
        }

        // 3D VIEWER FUNCTION
        window.openViewer = function(filePath, containerId) {
            const container = document.getElementById(containerId);
            
            // Toggle Logic
            if(container.style.display === 'block') {
                container.style.display = 'none'; 
                container.innerHTML = ''; // Clear memory
                return;
            }

            container.style.display = 'block';
            container.innerHTML = '<p style="color:white;text-align:center;padding-top:150px;">Loading Model...</p>';

            // CDN Link Construction
            const cdnUrl = `https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}/${filePath}`;

            const width = container.clientWidth;
            const height = 400;
            
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2a2a2a);
            
            const camera = new THREE.PerspectiveCamera(45, width/height, 0.1, 2000);
            const renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(width, height);
            
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            // Lights
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(50,50,50);
            scene.add(light);

            new STLLoader().load(cdnUrl, (geo) => {
                container.innerHTML='';
                container.appendChild(renderer.domElement);
                
                geo.center();
                const material = new THREE.MeshPhongMaterial({color:0x00ccff, specular:0x111111, shininess: 100});
                const mesh = new THREE.Mesh(geo, material);
                
                mesh.rotation.x = -Math.PI/2; // Fix orientation
                scene.add(mesh);
                
                // Auto Zoom
                const box = new THREE.Box3().setFromObject(mesh);
                const size = box.getSize(new THREE.Vector3()).length();
                camera.position.set(size, size, size);
                camera.lookAt(0,0,0);

                function animate(){ 
                    requestAnimationFrame(animate); 
                    controls.update(); 
                    renderer.render(scene, camera); 
                }
                animate();

            }, (xhr) => {
                 // Progress log could go here
            }, (err) => {
                container.innerHTML = '<p style="color:#ff6b6b;text-align:center;padding-top:150px;">Error: Could not load file.<br>Check branch name or file integrity.</p>';
                console.error(err);
            });
        };

        listFiles();
    </script>
</body>
</html>
