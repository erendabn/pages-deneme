<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STL G√∂r√ºnt√ºleyici</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .file-card {
            background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px;
            display: flex; flex-direction: column; gap: 10px; border: 1px solid #ddd;
        }
        .file-info { display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 5px 10px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-preview { background: #0969da; color: white; }
        .btn-download { background: #2ea44f; color: white; text-decoration: none; }
        
        /* 3D G√∂r√ºnt√ºleme Alanƒ± */
        .viewer-container {
            width: 100%; height: 300px; background: #333; 
            display: none; /* Ba≈ülangƒ±√ßta gizli */
            border-radius: 4px; overflow: hidden; position: relative;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <h1>STL Dosyalarƒ±</h1>
    <div id="list-area">Y√ºkleniyor...</div>

    <script type="module">
        import * as THREE from 'three';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const owner = 'coprint';
        const repo = 'AssemblingParts';
        const path = ''; // Ana dizin

        // STL G√∂sterme Fonksiyonu
        window.showSTL = async (url, containerId) => {
            const container = document.getElementById(containerId);
            
            // Eƒüer zaten a√ßƒ±ksa kapat
            if (container.style.display === 'block') {
                container.style.display = 'none';
                container.innerHTML = ''; // ƒ∞√ßini temizle (Bellek dostu olmasƒ± i√ßin)
                return;
            }

            container.style.display = 'block';
            container.innerHTML = '<p style="color:white; text-align:center; padding-top:20px;">Model Y√ºkleniyor...</p>';

            // 1. Sahne Kurulumu
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x333333);

            // 2. Kamera
            const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 150);

            // 3. Renderer (√áizici)
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.innerHTML = ''; // "Y√ºkleniyor" yazƒ±sƒ±nƒ± sil
            container.appendChild(renderer.domElement);

            // 4. I≈üƒ±klar
            const ambientLight = new THREE.AmbientLight(0x404040, 2); 
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(1, 1, 1);
            scene.add(dirLight);

            // 5. Kontroller (Mouse ile √ßevirme)
            const controls = new OrbitControls(camera, renderer.domElement);

            // 6. STL Y√ºkleyici
            const loader = new STLLoader();
            loader.load(
                url,
                function (geometry) {
                    // Modeli ortala ve materyal ekle
                    geometry.center(); 
                    const material = new THREE.MeshPhongMaterial({ color: 0x00ff00, specular: 0x111111, shininess: 200 });
                    const mesh = new THREE.Mesh(geometry, material);
                    
                    // Boyutu ekrana sƒ±ƒüacak ≈üekilde ayarla (Scale)
                    // (Basit bir normalizasyon)
                    mesh.rotation.x = -Math.PI / 2; 
                    scene.add(mesh);

                    // Kamerayƒ± modele g√∂re ayarla
                    const box = new THREE.Box3().setFromObject(mesh);
                    const size = box.getSize(new THREE.Vector3()).length();
                    camera.position.z = size * 1.5;
                },
                (xhr) => { console.log((xhr.loaded / xhr.total * 100) + '% y√ºklendi'); },
                (error) => { container.innerHTML = '<p style="color:red">Hata olu≈ütu</p>'; }
            );

            // 7. Animasyon D√∂ng√ºs√º
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        };

        // Dosyalarƒ± Listeleme
        async function loadFiles() {
            const container = document.getElementById('list-area');
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            
            try {
                const req = await fetch(apiUrl);
                const data = await req.json();
                container.innerHTML = '';

                // Sadece STL dosyalarƒ±nƒ± al
                const files = data.filter(item => item.name.toLowerCase().endsWith('.stl'));

                files.forEach((file, index) => {
                    const uniqueId = `viewer-${index}`;
                    const div = document.createElement('div');
                    div.className = 'file-card';
                    div.innerHTML = `
                        <div class="file-info">
                            <strong>${file.name}</strong>
                            <div>
                                <button class="btn btn-preview" onclick="showSTL('${file.download_url}', '${uniqueId}')">üëÅÔ∏è √ñnizle</button>
                                <a href="${file.download_url}" class="btn btn-download">ƒ∞ndir</a>
                            </div>
                        </div>
                        <div id="${uniqueId}" class="viewer-container"></div>
                    `;
                    container.appendChild(div);
                });

            } catch (e) {
                console.log(e);
            }
        }

        loadFiles();
    </script>
</body>
</html>
