<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoPrint Par√ßa G√∂r√ºnt√ºleyici</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        /* Modern ve Temiz Tasarƒ±m */
        body { font-family: 'Segoe UI', sans-serif; background: #f6f8fa; padding: 20px; max-width: 900px; margin: 0 auto; color: #24292f; }
        h1 { text-align: center; border-bottom: 1px solid #d0d7de; padding-bottom: 15px; }

        /* Navigasyon (Breadcrumb) */
        .breadcrumb { background: #fff; padding: 12px; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 20px; font-weight: 500; }
        .breadcrumb a { text-decoration: none; color: #0969da; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { color: #57606a; margin: 0 5px; }

        /* Liste Elemanlarƒ± */
        .item-card {
            background: #fff; border: 1px solid #d0d7de; padding: 15px; margin-bottom: 10px; border-radius: 6px;
            display: flex; flex-direction: column; gap: 10px; transition: box-shadow 0.2s;
        }
        .item-card:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.05); }

        .item-header { display: flex; justify-content: space-between; align-items: center; }
        
        .folder-link { text-decoration: none; color: #24292f; font-weight: bold; display: flex; align-items: center; gap: 8px; width: 100%; }
        .folder-link:hover { color: #0969da; }

        .btn { padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 600; border: 1px solid rgba(27, 31, 35, 0.15); cursor: pointer; }
        .btn-preview { background-color: #f6f8fa; color: #24292f; margin-right: 5px; }
        .btn-preview:hover { background-color: #f3f4f6; }
        .btn-download { background-color: #2ea44f; color: white; border-color: rgba(27, 31, 35, 0.15); }
        .btn-download:hover { background-color: #2c974b; }

        /* 3D Viewer Alanƒ± */
        .viewer-box {
            width: 100%; height: 350px; background: #1a1a1a; 
            border-radius: 6px; margin-top: 10px; display: none; position: relative;
        }
        .loading-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-family: monospace;
        }
    </style>
</head>
<body>

    <h1>Assembling Parts Deposu</h1>

    <div class="breadcrumb" id="breadcrumb">
        <a href="?path=">üè† Ana Dizin</a>
    </div>

    <div id="file-list">
        <p style="text-align:center">Y√ºkleniyor...</p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- AYARLAR ---
        const owner = 'coprint';
        const repo = 'AssemblingParts';
        // ---------------

        // URL'den mevcut klas√∂r yolunu al
        const params = new URLSearchParams(window.location.search);
        const currentPath = params.get('path') || '';

        // Breadcrumb G√ºncelle
        const breadcrumb = document.getElementById('breadcrumb');
        if (currentPath) {
            const parts = currentPath.split('/');
            let builtPath = '';
            parts.forEach(part => {
                builtPath += (builtPath ? '/' : '') + part;
                breadcrumb.innerHTML += ` <span>/</span> <a href="?path=${builtPath}">${part}</a>`;
            });
        }

        // 3D G√∂sterme Fonksiyonu (Global eri≈üim i√ßin window'a atadƒ±k)
        window.togglePreview = function(url, containerId) {
            const container = document.getElementById(containerId);
            
            // A√ßƒ±ksa kapat
            if (container.style.display === 'block') {
                container.style.display = 'none';
                container.innerHTML = ''; // Belleƒüi temizle
                return;
            }

            // Kapalƒ±ysa a√ß ve Y√ºkle
            container.style.display = 'block';
            container.innerHTML = '<div class="loading-text">Model Y√ºkleniyor...</div>';

            initThreeJS(url, container);
        };

        function initThreeJS(url, container) {
            const width = container.clientWidth;
            const height = container.clientHeight;

            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(0, 0, 100);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.innerHTML = ''; // Loading yazƒ±sƒ±nƒ± sil
            container.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // I≈üƒ±klandƒ±rma
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(50, 50, 50);
            scene.add(dirLight);

            // Dosyayƒ± Y√ºkle
            const loader = new STLLoader();
            loader.load(url, function (geometry) {
                geometry.center(); // Modeli merkeze al
                
                // Rastgele renk yerine end√ºstriyel gri/turuncu
                const material = new THREE.MeshPhongMaterial({ color: 0xff5500, specular: 0x111111, shininess: 200 });
                const mesh = new THREE.Mesh(geometry, material);

                // Modeli d√ºzelt (STL genelde ters gelir)
                mesh.rotation.x = -Math.PI / 2;
                
                scene.add(mesh);

                // Kamerayƒ± modele g√∂re zoomla
                const box = new THREE.Box3().setFromObject(mesh);
                const size = box.getSize(new THREE.Vector3()).length();
                const center = box.getCenter(new THREE.Vector3());
                
                camera.position.copy(center);
                camera.position.z += size * 1.5;
                camera.lookAt(center);

            }, undefined, function (error) {
                container.innerHTML = '<div class="loading-text" style="color:#ff6b6b">Y√ºkleme Hatasƒ±!</div>';
            });

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }

        // API'den Verileri √áek
        async function fetchRepoContents() {
            const listArea = document.getElementById('file-list');
            const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${currentPath}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API Hatasƒ±: ${response.status}`);
                
                const data = await response.json();
                listArea.innerHTML = '';

                // √ñnce Klas√∂rleri, Sonra Dosyalarƒ± Sƒ±rala
                data.sort((a, b) => (a.type === b.type ? 0 : a.type === 'dir' ? -1 : 1));

                if(data.length === 0) { listArea.innerHTML = '<p style="text-align:center">Klas√∂r bo≈ü.</p>'; return; }

                data.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    
                    if (item.type === 'dir') {
                        // KLAS√ñR G√ñR√úN√úM√ú
                        const nextPath = currentPath ? `${currentPath}/${item.name}` : item.name;
                        div.innerHTML = `
                            <div class="item-header">
                                <a href="?path=${nextPath}" class="folder-link">üìÇ ${item.name}</a>
                            </div>`;
                    } else {
                        // DOSYA G√ñR√úN√úM√ú
                        const isSTL = item.name.toLowerCase().endsWith('.stl');
                        const viewerId = `view-${index}`;
                        
                        let buttonsHtml = `<a href="${item.download_url}" class="btn btn-download" target="_blank">‚¨á ƒ∞ndir</a>`;
                        
                        // Sadece STL ise √ñnizle butonu ekle
                        if (isSTL) {
                            buttonsHtml = `
                                <button class="btn btn-preview" onclick="togglePreview('${item.download_url}', '${viewerId}')">üëÅÔ∏è √ñnizle</button>
                                ${buttonsHtml}
                            `;
                        }

                        div.innerHTML = `
                            <div class="item-header">
                                <span>üìÑ ${item.name}</span>
                                <div>${buttonsHtml}</div>
                            </div>
                            <div id="${viewerId}" class="viewer-box"></div>
                        `;
                    }
                    listArea.appendChild(div);
                });

            } catch (error) {
                listArea.innerHTML = `<p style="color:red; text-align:center">Veriler √ßekilemedi. (${error.message})<br>GitHub API limiti dolmu≈ü olabilir.</p>`;
            }
        }

        fetchRepoContents();
    </script>
</body>
</html>
